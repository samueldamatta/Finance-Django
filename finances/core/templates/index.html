{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Financeira - Dashboard</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/dashboard-styles.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Adicionar Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-chart-line"></i> FinanceApp</h2>
        </div>
        <ul class="sidebar-menu">
            <li class="active">
                <a href="{% url 'index' %}">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li>
                <a href="{% url 'despesas' %}">
                    <i class="fas fa-arrow-down"></i>
                    <span>Despesas</span>
                </a>
            </li>
            <li>
                <a href="{% url 'receitas' %}">
                    <i class="fas fa-arrow-up"></i>
                    <span>Receitas</span>
                </a>
            </li>
            <li>
                <a href="{% url 'categorias' %}">
                    <i class="fas fa-tags"></i>
                    <span>Categorias</span>
                </a>
            </li>
            <li>
                <a href="#reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Relatórios</span>
                </a>
            </li>
            <li>
                <a href="#settings">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Dashboard</h1>
            </div>
            <div class="header-right">
                <div class="user-profile">
                    <span class="user-name">João Silva</span>
                    <button class="logout-btn" title="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="card balance-card">
                    <div class="card-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="card-content">
                        <h3>Saldo Atual</h3>
                        <p class="amount {% if saldo_atual >= 0 %}positive{% else %}negative{% endif %}">
                            R$ {{ saldo_atual|floatformat:2 }}
                        </p>
                    </div>
                </div>
                
                <div class="card income-card">
                    <div class="card-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="card-content">
                        <h3>Receitas do Mês</h3>
                        <p class="amount positive">R$ {{ total_receitas|floatformat:2 }}</p>
                    </div>
                </div>
                
                <div class="card expense-card">
                    <div class="card-icon">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="card-content">
                        <h3>Despesas do Mês</h3>
                        <p class="amount negative">R$ {{ total_despesas|floatformat:2 }}</p>
                    </div>
                </div>
            </div>

            <!-- Seção de Gráficos -->
            <div class="charts-section">
                <div class="chart-container">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-bar"></i>
                                Gastos por Categoria
                            </h3>
                        </div>
                        <div class="chart-wrapper">
                            {% if categorias_labels %}
                                <canvas id="categoryChart" width="400" height="200"></canvas>
                            {% else %}
                                <div class="empty-chart">
                                    <i class="fas fa-chart-bar"></i>
                                    <p>Adicione despesas com categorias para ver o gráfico</p>
                                    <a href="{% url 'despesas' %}" class="btn btn-primary">
                                        <i class="fas fa-plus"></i>
                                        Adicionar Despesa
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="category-stats">
                    {% if categorias_labels %}
                    <div class="card stat-card">
                        <div class="stat-content">
                            <div class="stat-icon highest">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Maior Gasto</h4>
                                <p class="category-name">{{ categoria_maior_gasto }}</p>
                                <p class="stat-value negative">R$ {{ valor_maior_gasto|floatformat:2 }}</p>
                            </div>
                        </div>
                    </div>

                    <div class="card stat-card">
                        <div class="stat-content">
                            <div class="stat-icon lowest">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Menor Gasto</h4>
                                <p class="category-name">{{ categoria_menor_gasto }}</p>
                                <p class="stat-value">R$ {{ valor_menor_gasto|floatformat:2 }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Transações Recentes -->
            <div class="transactions-section">
                <div class="card">
                    <div class="card-header">
                        <h3>Transações Recentes</h3>
                    </div>
                    <div class="transactions-list">
                        {% if transacoes_recentes %}
                            {% for transacao in transacoes_recentes %}
                                <div class="transaction-item">
                                    <div class="transaction-icon {% if transacao.transaction_type == 'receita' %}income{% else %}expense{% endif %}">
                                        {% if transacao.transaction_type == 'receita' %}
                                            <i class="fas fa-plus-circle"></i>
                                        {% else %}
                                            <i class="fas fa-minus-circle"></i>
                                        {% endif %}
                                    </div>
                                    <div class="transaction-details">
                                        <h4>
                                            {% if transacao.description %}
                                                {{ transacao.description }}
                                            {% else %}
                                                {% if transacao.transaction_type == 'receita' %}Receita{% else %}Despesa{% endif %}
                                            {% endif %}
                                        </h4>
                                        <p>{{ transacao.transaction_type|capfirst }} • {{ transacao.date|date:"d/m/Y" }}</p>
                                    </div>
                                    <div class="transaction-amount {% if transacao.transaction_type == 'receita' %}positive{% else %}negative{% endif %}">
                                        {% if transacao.transaction_type == 'receita' %}+{% else %}-{% endif %}R$ {{ transacao.amount|floatformat:2 }}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-transactions">
                                <p>Nenhuma transação encontrada.</p>
                                <p>Comece adicionando sua primeira transação!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <a href="{% url 'receitas' %}" class="action-btn primary">
                    <i class="fas fa-plus"></i>
                    Nova Receita
                </a>
                <a href="{% url 'despesas' %}" class="action-btn secondary">
                    <i class="fas fa-minus"></i>
                    Nova Despesa
                </a>
                <a href="#" class="action-btn tertiary">
                    <i class="fas fa-chart-line"></i>
                    Ver Relatórios
                </a>
            </div>
        </div>
    </main>

    <!-- Adicionar JavaScript no final, antes de </body> -->
    <script>
        // Configuração do gráfico de categorias
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se as variáveis existem
            const labelsRaw = '{{ categorias_labels|default:"[]"|safe }}';
            const dataRaw = '{{ categorias_values|default:"[]"|safe }}';
            
            let labels, data;
            try {
                labels = labelsRaw !== '[]' ? {{ categorias_labels|safe }} : [];
                data = dataRaw !== '[]' ? {{ categorias_values|safe }} : [];
            } catch (e) {
                labels = [];
                data = [];
            }
            
            // Verificar se há dados e se o elemento existe
            if (labels.length === 0 || data.length === 0) return;
            
            const ctxElement = document.getElementById('categoryChart');
            if (!ctxElement) return;
            
            const ctx = ctxElement.getContext('2d');
            
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#e74c3c', '#2ecc71'
            ];
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gastos (R$)',
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: colors.slice(0, labels.length),
                        borderWidth: 1,
                        borderRadius: 5,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        });
    </script>

</body>
</html>